(()=>{var e,t={0:(e,t,n)=>{var a=n(994);Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=a(n(280)),s=a(n(293)),r=a(n(693)),l=a(n(383)),o=a(n(579)),u=a(n(452)),c=a(n(72)),m=a(n(511)),d=n(86),p=a(n(428)),h=a(n(334));function _(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function y(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?_(Object(n),!0).forEach((function(t){(0,r.default)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):_(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function f(e,t,n){return t=(0,c.default)(t),(0,u.default)(e,v()?Reflect.construct(t,n||[],(0,c.default)(e).constructor):t.apply(e,n))}function v(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(v=function(){return!!e})()}function b(e){d.BaseGateway.call(this,e),d.CheckoutGateway.call(this)}b.prototype=Object.assign(b.prototype,d.BaseGateway.prototype,d.CheckoutGateway.prototype);var g=function(e){function t(e){var n;return(0,l.default)(this,t),(n=f(this,t,[e])).setupIntent=null,n.paymentMethodType=null,n.paymentElementComplete=!1,n}return(0,m.default)(t,e),(0,o.default)(t,[{key:"initialize",value:function(){window.addEventListener("hashchange",this.handleHashChange.bind(this)),(0,p.default)(document.body).on("click","#place_order",this.handlePlaceOrder.bind(this)),(0,p.default)(document.body).on("change",'[name="'.concat(this.gateway_id,'_saved_method_key"]'),(0,h.default)(this.maybeInitializeInstallments.bind(this),250)),(0,p.default)(document.body).on("wc_stripe_saved_method_".concat(this.gateway_id),(0,h.default)(this.maybeInitializeInstallments.bind(this),250)),(0,p.default)(document.body).on("change",'[name="billing_email"], [name="billing_phone"], [name="billing_first_name"], [name="billing_last_name"]',this.onFieldChange.bind(this)),this.createPaymentElement(),this.mountPaymentElement(),this.initializeSetupIntent()}},{key:"disable_payment_button",value:function(){(0,p.default)("#place_order").prop("disabled",!0)}},{key:"enable_payment_button",value:function(){(0,p.default)("#place_order").prop("disabled",!1)}},{key:"createPaymentElement",value:function(){this.paymentElement=this.elements.create("payment",y({fields:{billingDetails:this.is_current_page("checkout")?{address:"never",name:(0,p.default)("#billing_first_name").length?"never":"auto",email:(0,p.default)("#billing_email").length?"never":"auto",phone:(0,p.default)("#billing_phone").length?"never":"auto"}:"auto"},wallets:{applePay:"never",googlePay:"never"},defaultValues:{billingDetails:{name:this.fields.get("billing_first_name")+" "+this.fields.get("billing_last_name"),email:this.fields.get("billing_email"),phone:this.fields.get("billing_phone")}}},this.params.paymentElementOptions)),this.paymentElement.on("change",this.onPaymentElementChange.bind(this))}},{key:"mountPaymentElement",value:function(){this.paymentElement.mount("#wc-stripe-upm-element")}},{key:"isPaymentMode",value:function(){return"payment"===this.params.elementOptions.mode}},{key:"isSubscriptionMode",value:function(){return"subscription"===this.params.elementOptions.mode}},{key:"isSetupMode",value:function(){return"setup"===this.params.elementOptions.mode}},{key:"shouldCreatePaymentMethod",value:function(){return!["blik","boleto"].includes(this.paymentMethodType)}},{key:"get_element_options",value:function(){var e=y(y({},(this.isPaymentMode()||this.isSubscriptionMode())&&{amount:100}),{},{currency:this.params.currency.toLowerCase()},this.params.elementOptions),t={};return this.has_gateway_data()&&(t.currency=this.get_currency().toLowerCase(),(this.isPaymentMode()||this.isSubscriptionMode())&&(t.amount=this.get_total_price_cents(),t.amount<=0&&(t.amount=100))),y(y({},e),t)}},{key:"updated_checkout",value:function(e,t){this.updatePaymentElement(t),this.mountPaymentElement(),this.handleInstallments(),this.initializeSetupIntent()}},{key:"onPaymentElementChange",value:function(e){var t=e.value,n=void 0===t?null:t,a=e.complete,i=void 0!==a&&a;this.paymentElementComplete=i,null!=n&&n.type&&(this.paymentMethodType=n.type,this.setPaymentMethodType(n.type)),this.handleInstallments()}},{key:"updatePaymentElement",value:function(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(t&&null!=t&&null!==(e=t.fragments)&&void 0!==e&&e[".wc-stripe-element-options"])try{var n=JSON.parse(window.atob(decodeURIComponent(t.fragments[".wc-stripe-element-options"])));this.params.elementOptions.mode!==n.mode&&(this.params.elementOptions=y(y({},this.params.elementOptions),n),this.elements.update(this.get_element_options()))}catch(e){}}},{key:"handleHashChange",value:function(e){var t=window.location.hash.match(/response=(.*)/);if(t)try{var n=JSON.parse(window.atob(decodeURIComponent(t[1])));n&&n.hasOwnProperty("client_secret")&&n.stripe_upm&&(history.pushState({},"",window.location.pathname),"payment_intent"===n.type?this.processPaymentIntent(n):this.processSetupIntent(n))}catch(e){}return!0}},{key:"handlePlaceOrder",value:function(e){var t=this;this.is_gateway_selected()&&(this.is_saved_method_selected()||(e.preventDefault(),this.disable_payment_button(),this.elements.submit().then((function(e){return e.error?t.submit_error(e.error):t.isPaymentMode()&&t.shouldCreatePaymentMethod()?t.stripe.createPaymentMethod({elements:t.elements,params:{billing_details:t.get_billing_details()}}).then((function(e){if(e.error)return t.submit_error(e.error);t.is_current_page("order_pay")?(t.set_nonce(e.paymentMethod.id),t.process_order_pay()):t.on_token_received(e.paymentMethod)})).catch((function(e){return t.submit_error(e)})):t.isSetupMode()&&t.setupIntent?(t.block(),t.processSetupIntent({client_secret:t.setupIntent.client_secret,confirmParams:t.params.confirmParams}).finally((function(){t.unblock()}))):(t.payment_token_received=!0,void t.get_form().trigger("submit"))})).catch((function(e){return t.enable_payment_button(),t.submit_error(e)})).finally((function(){t.enable_payment_button()}))))}},{key:"on_token_received",value:function(e){this.payment_token_received=!0,this.set_nonce(e.id),this.setPaymentMethodType(e.type),this.get_form().trigger("submit")}},{key:"setPaymentMethodType",value:function(e){(0,p.default)("#_stripe_payment_method_type").val(e)}},{key:"handle_next_action",value:function(e){"payment_intent"===e.type?this.processPaymentIntent(e):this.processSetupIntent(e)}},{key:"processPaymentIntent",value:function(e){var t=this;this.stripe.confirmPayment(y(y({},!this.is_saved_method_selected()&&{elements:this.elements}),{},{clientSecret:e.client_secret,redirect:"if_required",confirmParams:{return_url:e.return_url,payment_method_data:{billing_details:e.billing_details||this.get_billing_details()}}})).then((function(n){if(n.error)return t.payment_token_received=!1,t.submit_error(n.error);var a=decodeURI(e.return_url);if(a+="&"+p.default.param({_stripe_local_payment:t.gateway_id,payment_intent:n.paymentIntent.id,payment_intent_client_secret:n.paymentIntent.client_secret}),["promptpay","swish","paynow","cashapp"].includes(t.paymentMethodType)){if("requires_action"===n.paymentIntent.status)return t.get_form().unblock().removeClass("processing");if("requires_payment_method"===n.paymentIntent.status)return t.get_form().unblock().removeClass("processing"),t.submit_error({code:n.paymentIntent.last_payment_error.code})}window.location.href=a})).catch((function(e){return t.submit_error(e)}))}},{key:"processSetupIntent",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return this.stripe.confirmSetup(y({elements:this.elements,clientSecret:t.client_secret,redirect:"if_required"},t&&{confirmParams:y(y({},t.return_url&&{return_url:t.return_url}),{},{payment_method_data:{billing_details:this.get_billing_details()}},t.confirmParams&&t.confirmParams)})).then((function(t){if(t.error)return e.payment_token_received=!1,e.submit_error(t.error);e.payment_token_received=!0,e.set_nonce(t.setupIntent.payment_method),e.set_intent(t.setupIntent.id),e.get_form().trigger("submit")})).catch((function(t){return e.submit_error(t)}))}},{key:"handleInstallments",value:function(){this.installmentsEnabled()&&(this.maybeShowInstallments(),this.paymentElementComplete&&this.isCardPaymentType()&&this.initializeInstallments())}},{key:"isCardPaymentType",value:function(){return"card"===this.paymentMethodType}},{key:"maybeShowInstallments",value:function(){this.is_saved_method_selected()?"stripe_cc"===this.savedPaymentTokenGatewayId?this.showInstallments():this.hideInstallments():this.isCardPaymentType()?this.showInstallments():this.hideInstallments()}},{key:"showInstallments",value:function(){(0,p.default)(this.container).find(".wc-stripe-installment-container").show()}},{key:"hideInstallments",value:function(){(0,p.default)(this.container).find(".wc-stripe-installment-container").hide()}},{key:"installmentsEnabled",value:function(){if(this.has_gateway_data()){var e,t=this.get_gateway_data();return!(null==t||null===(e=t.installments)||void 0===e||!e.enabled)}return!1}},{key:"maybeInitializeInstallments",value:function(){this.installmentsEnabled()&&this.is_saved_method_selected()&&(this.savedPaymentTokenGatewayId=(0,p.default)("".concat(this.saved_method_selector," option:selected")).data("gateway"),"stripe_cc"===this.savedPaymentTokenGatewayId&&this.initializeInstallments(this.get_selected_payment_method()),this.maybeShowInstallments())}},{key:"initializeInstallments",value:(a=(0,s.default)(i.default.mark((function e(){var t,n,a=arguments;return i.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(t=a.length>0&&void 0!==a[0]?a[0]:null)){e.next=16;break}return this.showInstallmentLoader(),e.prev=3,e.next=6,this.fetchInstallmentPlans(t);case 6:e.next=11;break;case 8:e.prev=8,e.t0=e.catch(3),console.log(e.t0);case 11:return e.prev=11,this.hideInstallmentLoader(),e.finish(11);case 14:e.next=32;break;case 16:return e.prev=16,e.next=19,this.elements.submit();case 19:return e.next=21,this.stripe.createPaymentMethod({elements:this.elements,params:{billing_details:this.get_billing_details()}});case 21:if((n=e.sent).error){e.next=25;break}return e.next=25,this.initializeInstallments(n.paymentMethod.id);case 25:e.next=30;break;case 27:e.prev=27,e.t1=e.catch(16),this.hideInstallmentLoader();case 30:return e.prev=30,e.finish(30);case 32:case"end":return e.stop()}}),e,this,[[3,8,11,14],[16,27,30,32]])}))),function(){return a.apply(this,arguments)})},{key:"fetchPaymentIntent",value:function(e){var t=this;return new Promise((function(n,a){var i=t.params.routes.create_payment_intent,s=!1;t.is_current_page("order_pay")&&(i=t.params.routes.order_create_payment_intent,s=!0),p.default.ajax({url:i,method:"POST",dataType:"json",data:s?{payment_method_id:e,payment_method:"stripe_cc",order_id:t.get_gateway_data().order.id,order_key:t.get_gateway_data().order.key}:y(y({},t.serialize_fields()),{},{payment_method_id:e,payment_method:"stripe_cc",page_id:t.get_page()}),beforeSend:t.ajax_before_send.bind(t)}).done((function(e){e.code?a(e):n(e)})).fail((function(e){a()}))}))}},{key:"fetchInstallmentPlans",value:(n=(0,s.default)(i.default.mark((function e(t){var n;return i.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.fetchPaymentIntent(t);case 3:(n=e.sent).installments_html&&(0,p.default)(".wc-stripe-installment-container").replaceWith(n.installments_html),e.next=10;break;case 7:return e.prev=7,e.t0=e.catch(0),e.abrupt("return",this.submit_error(e.t0));case 10:case"end":return e.stop()}}),e,this,[[0,7]])}))),function(e){return n.apply(this,arguments)})},{key:"showInstallmentLoader",value:function(){(0,p.default)(".wc-stripe-installment-options").addClass("loading-installments"),(0,p.default)('[name="_stripe_installment_plan"] option:selected').eq(0).text(this.params.installments.loading),(0,p.default)(".wc-stripe-installment-loader").show()}},{key:"hideInstallmentLoader",value:function(){(0,p.default)(".wc-stripe-installment-options").removeClass("loading-installments"),(0,p.default)(".wc-stripe-installment-loader").hide()}},{key:"initializeSetupIntent",value:function(){var e=this;this.isSetupMode()&&!this.setupIntent&&this.create_setup_intent({context:this.get_page()}).then((function(t){t.intent&&(e.setupIntent=t.intent)})).catch((function(e){}))}},{key:"show_payment_button",value:function(){this.show_place_order()}},{key:"hide_place_order",value:function(){}},{key:"onFieldChange",value:function(e){this.paymentElement.update({defaultValues:{billingDetails:{name:(0,p.default)("#billing_first_name").val()+" "+(0,p.default)("#billing_last_name").val(),email:(0,p.default)("#billing_email").val(),phone:(0,p.default)("#billing_phone").val()}}})}}]);var n,a}(b);t.default=g},115:(e,t,n)=>{var a=n(994),i=a(n(579)),s=a(n(383)),r=a(n(0));new((0,i.default)((function e(t,n){(0,s.default)(this,e),this.gateway=t,this.params=n})))(new r.default(wc_stripe_upm_checkout_params),wc_stripe_upm_checkout_params)},428:e=>{"use strict";e.exports=window.jQuery},280:e=>{"use strict";e.exports=window.regeneratorRuntime},86:e=>{"use strict";e.exports=window.wc_stripe}},n={};function a(e){var i=n[e];if(void 0!==i)return i.exports;var s=n[e]={exports:{}};return t[e](s,s.exports,a),s.exports}a.m=t,e=[],a.O=(t,n,i,s)=>{if(!n){var r=1/0;for(c=0;c<e.length;c++){for(var[n,i,s]=e[c],l=!0,o=0;o<n.length;o++)(!1&s||r>=s)&&Object.keys(a.O).every((e=>a.O[e](n[o])))?n.splice(o--,1):(l=!1,s<r&&(r=s));if(l){e.splice(c--,1);var u=i();void 0!==u&&(t=u)}}return t}s=s||0;for(var c=e.length;c>0&&e[c-1][2]>s;c--)e[c]=e[c-1];e[c]=[n,i,s]},a.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{var e={367:0};a.O.j=t=>0===e[t];var t=(t,n)=>{var i,s,[r,l,o]=n,u=0;if(r.some((t=>0!==e[t]))){for(i in l)a.o(l,i)&&(a.m[i]=l[i]);if(o)var c=o(a)}for(t&&t(n);u<r.length;u++)s=r[u],a.o(e,s)&&e[s]&&e[s][0](),e[s]=0;return a.O(c)},n=self.webpackChunkwoo_stripe_payment=self.webpackChunkwoo_stripe_payment||[];n.forEach(t.bind(null,0)),n.push=t.bind(null,n.push.bind(n))})();var i=a.O(void 0,[96],(()=>a(115)));i=a.O(i)})();
//# sourceMappingURL=universal-payment-method.js.map