import API from"../api";import{lpAddQueryArgs,lpFetchAPI,lpGetCurrentURLNoParam}from"../utils";const classCourseFilter="lp-form-course-filter",classProcessing="processing";let timeOutSearch,controller,signal;document.addEventListener("submit",(function(e){const t=e.target;t.classList.contains(classCourseFilter)&&(e.preventDefault(),window.lpCourseFilter.submit(t))})),document.addEventListener("click",(function(e){const t=e.target;t.classList.contains("course-filter-reset")&&(e.preventDefault(),window.lpCourseFilter.reset(t)),window.lpCourseFilter.showHideSearchResult(t),window.lpCourseFilter.triggerInputChoice(t)})),document.addEventListener("keyup",(function(e){e.preventDefault();const t=e.target;t.classList.contains("lp-course-filter-search")&&window.lpCourseFilter.searchSuggestion(t)})),window.lpCourseFilter={searchSuggestion:e=>{if(1!==parseInt(e.dataset.searchSuggest||1))return;const t=e.value.trim(),s=e.closest(`.${classCourseFilter}`),r=s.querySelector(".lp-loading-circle");if(void 0!==timeOutSearch&&clearTimeout(timeOutSearch),t&&t.length>2)r.classList.remove("hide"),timeOutSearch=setTimeout((function(){window.lpCourseFilter.callAPICourseSuggest(t,(e=>{document.querySelector(".lp-course-filter-search-result").innerHTML=e.data.content,r.classList.add("hide")}))}),500);else{s.querySelector(".lp-course-filter-search-result").innerHTML="",r.classList.add("hide")}},callAPICourseSuggest:(e,t,s)=>{void 0!==controller&&controller.abort(),controller=new AbortController,signal=controller.signal;let r=API.frontend.apiCourses+"?c_search="+e+"&c_suggest=1";lpData.urlParams.hasOwnProperty("lang")&&(r+="&lang="+lpData.urlParams.lang);let a={method:"GET"};0!==parseInt(lpData.user_id)&&(a={...a,headers:{"X-WP-Nonce":lpData.nonce}}),fetch(r,{...a,signal:signal}).then((e=>e.json())).then((e=>{void 0!==t&&t(e)})).catch((e=>{console.log(e)})).finally((()=>{void 0!==s&&s()}))},loadWidgetFilterREST:e=>{const t=e.closest(".learnpress-widget-wrapper:not(.processing)");if(!t)return;t.classList.add("processing");const s=e.closest("div[data-widget]");let r=null;if(s){const e=JSON.parse(s.dataset.widget),t=JSON.parse(e.instance).class_list_courses_target||".lp-list-courses-default";r=document.querySelector(t)}const a=t.dataset.widget?JSON.parse(t.dataset.widget):"",l=lpData.urlParams.lang?`?lang=${lpData.urlParams.lang}`:"",o=API.frontend.apiWidgets+l,n=new FormData(e),c={paged:1},i=t.querySelector(".lp-widget-loading-change");i.style.display="block";for(const e of n.entries()){const t=e[0],s=n.getAll(t);if(!c.hasOwnProperty(t)){let e=s;"object"==typeof s&&(e=s.join(",")),c[t]=e}}void 0!==lpData.urlParams.page_term_id_current?c.page_term_id_current=lpData.urlParams.page_term_id_current:void 0!==lpData.urlParams.page_tag_id_current&&(c.page_tag_id_current=lpData.urlParams.page_tag_id_current);const u={params_url:c};lpData.urlParams.hasOwnProperty("lang")&&(u.params_url.lang=lpData.urlParams.lang);const p={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...a,...u})};0!==parseInt(lpData.user_id)&&(p.headers["X-WP-Nonce"]=lpData.nonce);lpFetchAPI(o,p,{before:()=>{},success:s=>{const{data:r,status:a,message:l}=s;r&&"success"===a?e.innerHTML=r:l&&t.insertAdjacentHTML("afterbegin",`<div class="lp-ajax-message error" style="display:block">${l}</div>`)},error:e=>{},completed:()=>{const e=setInterval((()=>{r.classList.contains("processing")||(clearInterval(e),i.style.display="none",t.classList.remove("processing"))}),1)}})},submit:e=>{const t=new FormData(e),s=document.querySelector(".learn-press-courses"),r=e.closest("div[data-widget]");let a=null;if(r){const e=JSON.parse(r.dataset.widget),t=JSON.parse(e.instance).class_list_courses_target||".lp-list-courses-default";a=document.querySelector(t)}const l={paged:1};void 0!==window.lpCourseList&&window.lpCourseList.updateEventTypeBeforeFetch("filter");for(const e of t.entries()){const s=e[0],r=t.getAll(s);l.hasOwnProperty(s)||(l[s]=r.join(","))}if(void 0!==lpData.urlParams.page_term_id_current&&(l.page_term_id_current=lpData.urlParams.page_term_id_current),void 0!==lpData.urlParams.page_tag_id_current&&(l.page_tag_id_current=lpData.urlParams.page_tag_id_current),lpData.urlParams.hasOwnProperty("lang")&&(l.lang=lpData.urlParams.lang),"undefined"!=typeof lpSettingCourses&&lpData.is_course_archive&&lpSettingCourses.lpArchiveLoadAjax&&s&&!a&&void 0!==window.lpCourseList)window.lpCourseList.triggerFetchAPI(l);else if(a){if(a.classList.contains("processing"))return;a.classList.add("processing");const t=a.querySelector(".lp-target"),s={...JSON.parse(t.dataset.send)},r=a.closest("div:not(.lp-target)").querySelector(".lp-loading-change");r&&(r.style.display="block");const o=e.elements;for(let e=0;e<o.length;e++)l.hasOwnProperty(o[e].name)?s.args[o[e].name]=l[o[e].name]:delete s.args[o[e].name];s.args.paged=1,t.dataset.send=JSON.stringify(s),lpData.urlParams=l,window.history.pushState({},"",lpAddQueryArgs(lpGetCurrentURLNoParam(),lpData.urlParams)),window.lpCourseFilter.loadWidgetFilterREST(e);const n={success:e=>{const{status:s,message:r,data:a}=e;t.innerHTML=a.content||""},error:e=>{console.log(e)},completed:()=>{a.classList.remove("processing"),r&&(r.style.display="none")}};window.lpAJAXG.fetchAPI(API.frontend.apiAJAX,s,n)}else{const e=lpData.urlParams.page_term_url||lpData.courses_url||"",t=new URL(e);Object.keys(l).forEach((e=>{t.searchParams.set(e,l[e])})),document.location.href=t.href}},reset:e=>{const t=e.closest(`.${classCourseFilter}`);if(!t)return;const s=t.querySelector(".course-filter-submit"),r=t.querySelector(".lp-course-filter-search-result"),a=t.querySelector(".lp-course-filter-search");t.reset(),r&&(r.innerHTML=""),a&&(a.value="");for(let e=0;e<t.elements.length;e++)t.elements[e].removeAttribute("checked");s.click()},showHideSearchResult:e=>{const t=document.querySelector(".lp-course-filter-search-result");if(!t)return;e.closest(".lp-course-filter-search-result")||e.classList.contains("lp-course-filter-search-result")||e.classList.contains("lp-course-filter-search")?t.style.display="block":t.style.display="none"},triggerInputChoice:e=>{const t=e.closest(".lp-course-filter__field");if(t)if("INPUT"===e.tagName){const e=t.closest("div[data-widget]");let s=null;if(e){const r=JSON.parse(e.dataset.widget),a=JSON.parse(r.instance).class_list_courses_target||".lp-list-courses-default";s=document.querySelector(a);t.closest(`.${classCourseFilter}`).querySelector(".course-filter-submit").click()}}else t.querySelector("input").click()}};